# üî• –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–µ: –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤ —Å —Ä–∞–∑–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é

**–î–∞—Ç–∞:** 10 —Ñ–µ–≤—Ä–∞–ª—è 2026, 22:21 MSK  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  
**–ö–æ–º–º–∏—Ç:** [ce261fd](https://github.com/balzampsilo-sys/tg-bot-10_02/commit/ce261fdc406da2a030f954d1cf48bba54dd30572)

---

## üêû –ü–†–û–ë–õ–ï–ú–ê

### –û–ø–∏—Å–∞–Ω–∏–µ
–ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π —Å–ª–æ—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å **—Ö–∞—Ä–¥–∫–æ–¥–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 60 –º–∏–Ω—É—Ç** –¥–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ —É—Å–ª—É–≥ —Å –¥—Ä—É–≥–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.

### –ö–æ–¥ –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**`keyboards/user_keyboards.py` (—Å—Ç—Ä. 260-267):**
```python
# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±—Ä–æ–Ω–∏ —Ç–æ–∂–µ –∏–º–µ—é—Ç duration
# (–í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å duration –∏–∑ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–π –±—Ä–æ–Ω–∏)
occupied_end = occupied_datetime + timedelta(minutes=60)  # ‚ùå –•–ê–†–î–ö–û–î!
```

**`database/repositories/booking_repository.py` (—Å—Ç—Ä. 45-66):**
```python
@staticmethod
async def get_occupied_slots_for_day(date_str: str) -> Set[str]:
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã –∑–∞ –¥–µ–Ω—å"""
    occupied = set()
    # ‚ùå –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ TIME, –±–µ–∑ DURATION!
    bookings = await BookingRepository._execute_query(
        "SELECT time FROM bookings WHERE date=?", (date_str,), fetch_all=True
    )
```

### –°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–±–ª–µ–º—ã

üìÖ **–î–µ–Ω—å:** 2026-02-15  
üïí **–†–∞–±–æ—á–∏–µ —á–∞—Å—ã:** 9:00 - 18:00

**–®–∞–≥ 1:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —É—Å–ª—É–≥—É **"–î–ª–∏—Ç–µ–ª—å–Ω–∞—è (2 —á–∞—Å–∞)"** –Ω–∞ **10:00**
- ‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–µ—Ç—Å—è: `10:00-12:00`
- ‚úÖ –°–ª–æ—Ç 10:00 –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∑–∞–Ω—è—Ç—ã–π

**–®–∞–≥ 2:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É—Å–ª—É–≥—É **"–°—Ç–∞–Ω–¥–∞—Ä—Ç (1 —á–∞—Å)"** –Ω–∞ **11:00**

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- ‚ùå –°–ª–æ—Ç 11:00 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–ó–ê–ù–Ø–¢** (–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ 10:00-12:00 —Å 11:00-12:00)

**–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
- ‚úÖ –°–ª–æ—Ç 11:00 –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è –∫–∞–∫ **–°–í–û–ë–û–î–ï–ù** (—Ç.–∫. –ø—Ä–æ–≤–µ—Ä—è–ª–∞—Å—å —Ç–æ–ª—å–∫–æ 10:00-11:00)
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –º–æ–≥ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ 11:00
- üêû **–î–í–û–ô–ù–û–ï –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ï!**

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `get_occupied_slots_for_day()`

**–§–∞–π–ª:** `database/repositories/booking_repository.py`  
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```python
@staticmethod
async def get_occupied_slots_for_day(date_str: str) -> List[Tuple[str, int]]:
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã –∑–∞ –¥–µ–Ω—å —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
    
    Returns:
        List[Tuple[time_str, duration_minutes]]
        –ù–∞–ø—Ä–∏–º–µ—Ä: [('10:00', 60), ('14:00', 90), ('16:00', 120)]
    """
    occupied = []
    try:
        # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–ª—É—á–∞–µ–º time + duration –∏–∑ JOIN —Å services
        async with aiosqlite.connect(DATABASE_PATH) as db:
            # –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å duration –∏–∑ services
            async with db.execute(
                """SELECT b.time, COALESCE(s.duration_minutes, 60) as duration
                FROM bookings b
                LEFT JOIN services s ON b.service_id = s.id
                WHERE b.date = ?""",
                (date_str,)
            ) as cursor:
                bookings = await cursor.fetchall()
                if bookings:
                    occupied.extend((time, duration) for time, duration in bookings)

            # –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 60 –º–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            async with db.execute(
                "SELECT time FROM blocked_slots WHERE date = ?",
                (date_str,)
            ) as cursor:
                blocked = await cursor.fetchall()
                if blocked:
                    occupied.extend((time, 60) for (time,) in blocked)
                    
    except Exception as e:
        logging.error(f"Error getting occupied slots for {date_str}: {e}")

    return occupied
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ `LEFT JOIN services` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `duration_minutes`
- ‚úÖ `COALESCE(s.duration_minutes, 60)` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `List[Tuple[str, int]]` –≤–º–µ—Å—Ç–æ `Set[str]`

---

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `create_time_slots()`

**–§–∞–π–ª:** `keyboards/user_keyboards.py`  
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```python
# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü–æ–ª—É—á–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã –° –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–¨–Æ
occupied_slots = await Database.get_occupied_slots_for_day(date_str)

# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å –†–ï–ê–õ–¨–ù–û–ô –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
is_free = True
for occupied_time, occupied_duration in occupied_slots:  # ‚úÖ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º tuple!
    occupied_datetime_naive = datetime.combine(
        date_obj.date(),
        datetime.strptime(occupied_time, "%H:%M").time()
    )
    occupied_datetime = TIMEZONE.localize(occupied_datetime_naive)
    
    # ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –†–ï–ê–õ–¨–ù–£–Æ duration –∏–∑ –ë–î!
    occupied_end = occupied_datetime + timedelta(minutes=occupied_duration)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
    if slot_datetime < occupied_end and end_datetime > occupied_datetime:
        is_free = False
        break
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ `(occupied_time, occupied_duration)`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `occupied_duration` –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤

---

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `queries.py`

**–§–∞–π–ª:** `database/queries.py`  
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```python
@staticmethod
async def get_occupied_slots_for_day(date_str: str) -> List[Tuple[str, int]]:
    """–ü–æ–ª—É—á–∏—Ç—å –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
    
    Returns:
        List[Tuple[time_str, duration_minutes]]
    """
    return await BookingRepository.get_occupied_slots_for_day(date_str)
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ —Ç–∏–ø–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢

### –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

‚úÖ **–£—Å–ª—É–≥–∞ 1 —á–∞—Å** (60 –º–∏–Ω):  
- –ó–∞–Ω–∏–º–∞–µ—Ç 1 —Å–ª–æ—Ç  
- –ü—Ä–∏–º–µ—Ä: 10:00-11:00

‚úÖ **–£—Å–ª—É–≥–∞ 1.5 —á–∞—Å–∞** (90 –º–∏–Ω):  
- –ó–∞–Ω–∏–º–∞–µ—Ç 1.5 —Å–ª–æ—Ç–∞  
- –ü—Ä–∏–º–µ—Ä: 10:00-11:30  
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å–ª–æ—Ç—ã 10:00 –∏ 11:00

‚úÖ **–£—Å–ª—É–≥–∞ 2 —á–∞—Å–∞** (120 –º–∏–Ω):  
- –ó–∞–Ω–∏–º–∞–µ—Ç 2 —Å–ª–æ—Ç–∞  
- –ü—Ä–∏–º–µ—Ä: 10:00-12:00  
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å–ª–æ—Ç—ã 10:00 –∏ 11:00

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π:

üìÖ **–î–µ–Ω—å:** 2026-02-15  
üïí **–†–∞–±–æ—á–∏–µ —á–∞—Å—ã:** 9:00 - 18:00

**–ó–∞–ø–∏—Å—å 1:** 10:00, —É—Å–ª—É–≥–∞ "2 —á–∞—Å–∞" (10:00-12:00)  
**–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ 2:** 11:00, —É—Å–ª—É–≥–∞ "1 —á–∞—Å" (11:00-12:00)

‚ùå **–°–ª–æ—Ç 11:00 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω** (–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ 10:00-12:00 —Å 11:00-12:00) ‚úÖ

**–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è —É—Å–ª—É–≥–∏ "1 —á–∞—Å":**  
‚úÖ 9:00-10:00  
‚ùå 10:00-11:00 (–∑–∞–Ω—è—Ç–æ)  
‚ùå 11:00-12:00 (–∑–∞–Ω—è—Ç–æ)  
‚úÖ 12:00-13:00  
‚úÖ 13:00-14:00  
... –∏ —Ç.–¥.

---

## üìù –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

1. `database/repositories/booking_repository.py`
   - –ú–µ—Ç–æ–¥ `get_occupied_slots_for_day()` —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `List[Tuple[str, int]]`
   - –î–æ–±–∞–≤–ª–µ–Ω JOIN —Å —Ç–∞–±–ª–∏—Ü–µ–π `services`

2. `keyboards/user_keyboards.py`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –≤ `create_time_slots()`
   - –£–¥–∞–ª–µ–Ω —Ö–∞—Ä–¥–∫–æ–¥ 60 –º–∏–Ω—É—Ç

3. `database/queries.py`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `get_occupied_slots_for_day()`

---

## üõ†Ô∏è –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. ‚úÖ **–û–¥–Ω–∞ —É—Å–ª—É–≥–∞ 2 —á–∞—Å–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 2 —Å–ª–æ—Ç–∞**
   - –ó–∞–ø–∏—Å—å –Ω–∞ 10:00 (2—á) –±–ª–æ–∫–∏—Ä—É–µ—Ç 10:00 –∏ 11:00

2. ‚úÖ **–†–∞–∑–Ω—ã–µ —É—Å–ª—É–≥–∏ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è**
   - –ó–∞–ø–∏—Å—å 1: 10:00 (1—á)
   - –ó–∞–ø–∏—Å—å 2: 11:00 (1.5—á) ‚úÖ –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å

3. ‚úÖ **–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è**
   - –ó–∞–ø–∏—Å—å 1: 10:00 (2—á)
   - –ó–∞–ø–∏—Å—å 2: 11:00 (1—á) ‚ùå –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ

4. ‚úÖ **–£—Å–ª—É–≥–∞ 1.5—á –∑–∞–Ω–∏–º–∞–µ—Ç 1.5 —Å–ª–æ—Ç–∞**
   - –ó–∞–ø–∏—Å—å –Ω–∞ 10:00 (1.5—á) –±–ª–æ–∫–∏—Ä—É–µ—Ç 10:00 –∏ 11:00
   - –°–ª–æ—Ç 11:30 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≤–æ–±–æ–¥–µ–Ω ‚úÖ

---

## üîó –°–°–´–õ–ö–ò

- **–ö–æ–º–º–∏—Ç:** [ce261fd](https://github.com/balzampsilo-sys/tg-bot-10_02/commit/ce261fdc406da2a030f954d1cf48bba54dd30572)
- **PR:** –ù/–î (–ø—Ä—è–º–æ–π push –≤ main)
- **–°–≤—è–∑–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** [CRITICAL_FIXES_COMPLETED.md](./CRITICAL_FIXES_COMPLETED.md)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  
**–î–∞—Ç–∞:** 10.02.2026 22:21 MSK
