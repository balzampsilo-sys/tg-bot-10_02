name: Code Quality Checks

# Run on every push and pull request
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Check imports and syntax
  test-imports:
    name: Test Python Imports
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test all module imports
      run: |
        python -c "
        import sys
        import importlib
        errors = []
        
        # List of all critical modules to test
        modules = [
            'config',
            'database.queries',
            'database.repositories',
            'handlers.user_handlers',
            'handlers.admin_handlers',
            'handlers.booking_handlers',
            'handlers.service_management_handlers',
            'utils.states',
            'utils.helpers',
            'utils.validators',
            'keyboards.user_keyboards',
            'keyboards.admin_keyboards',
        ]
        
        print('\nüîç Testing imports...\n')
        for module in modules:
            try:
                importlib.import_module(module)
                print(f'‚úÖ {module}')
            except Exception as e:
                errors.append(f'‚ùå {module}: {e}')
                print(f'‚ùå {module}: {e}')
        
        if errors:
            print('\n‚ùå Failed imports:')
            for error in errors:
                print(error)
            sys.exit(1)
        else:
            print('\n‚úÖ All imports successful!')
        "

  # Job 2: Run flake8 linting
  lint:
    name: Lint with Flake8
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install flake8
      run: |
        pip install flake8
    
    - name: Run flake8
      run: |
        # Check for import errors, undefined variables, syntax errors
        flake8 . \
          --count \
          --select=E9,F63,F7,F82,F401,F811,F821,F822 \
          --show-source \
          --statistics \
          --exclude=venv,.git,__pycache__,*.pyc,migrations,backups

  # Job 3: Check code formatting
  format-check:
    name: Check Code Formatting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install black and isort
      run: |
        pip install black==24.1.1 isort==5.13.2
    
    - name: Check formatting with black
      run: |
        black --check --line-length=100 . --exclude="venv|migrations|backups"
    
    - name: Check import sorting with isort
      run: |
        isort --check-only --profile=black --line-length=100 . --skip venv --skip migrations

  # Job 4: Security scan
  security:
    name: Security Scan with Bandit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install bandit
      run: |
        pip install bandit[toml]==1.7.6
    
    - name: Run security scan
      run: |
        bandit -r . \
          -ll \
          --exclude venv,migrations,backups,.git \
          --format json \
          --output bandit-report.json || true
        
        # Show results
        bandit -r . \
          -ll \
          --exclude venv,migrations,backups,.git \
          --format screen
    
    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: bandit-security-report
        path: bandit-report.json

  # Job 5: Summary
  summary:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [test-imports, lint, format-check, security]
    if: success()
    
    steps:
    - name: Success message
      run: |
        echo "‚úÖ All code quality checks passed!"
        echo "‚úÖ Imports: OK"
        echo "‚úÖ Linting: OK"
        echo "‚úÖ Formatting: OK"
        echo "‚úÖ Security: OK"
