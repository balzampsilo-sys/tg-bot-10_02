# üõ†Ô∏è MessageCleanupMiddleware Integration Guide

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–Ω–æ–ø–æ–∫) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è:
- –û—à–∏–±–æ–∫ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –ó–∞–ø–∏—Å–µ–π –Ω–∞ —É–∂–µ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

---

## üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã

### 1. **MessageCleanupMiddleware** - –ë–∞–∑–æ–≤–∞—è

–ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º TTL.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—Å—Ç–æ—Ç–∞
- –ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ø–∞–º—è—Ç—å
- –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
- –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –±–æ—Ç–æ–≤

### 2. **RateLimitedCleanupMiddleware** - –° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —á–∞—Å—Ç–æ—Ç—ã

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- –î–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –±–æ—Ç–æ–≤
- –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å–æ —Å–ø–∞–º–æ–º

### 3. **SmartCleanupMiddleware** - –£–º–Ω–∞—è

–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π TTL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π TTL –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
- –ì–∏–±–∫–æ—Å—Ç—å
- –õ—É—á—à–∏–π UX

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- –î–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –±–æ—Ç–æ–≤
- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ —Ç–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –®–∞–≥ 1: –î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª

–§–∞–π–ª `middlewares/message_cleanup.py` —É–∂–µ —Å–æ–∑–¥–∞–Ω –≤ —ç—Ç–æ–º PR.

### –®–∞–≥ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ main.py

```python
# –í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
from middlewares.message_cleanup import (
    MessageCleanupMiddleware,
    RateLimitedCleanupMiddleware,
    SmartCleanupMiddleware
)

# –í —Ñ—É–Ω–∫—Ü–∏–∏ start_bot() –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è Dispatcher

# –í–∞—Ä–∏–∞–Ω—Ç 1: –ë–∞–∑–æ–≤–∞—è (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
dp.callback_query.middleware(MessageCleanupMiddleware(ttl_hours=48))

# –í–∞—Ä–∏–∞–Ω—Ç 2: –° rate limiting
# dp.callback_query.middleware(
#     RateLimitedCleanupMiddleware(ttl_hours=48, max_attempts=5)
# )

# –í–∞—Ä–∏–∞–Ω—Ç 3: –£–º–Ω–∞—è
# dp.callback_query.middleware(SmartCleanupMiddleware())

# –û—Å—Ç–∞–ª—å–Ω—ã–µ middlewares
dp.message.middleware(RateLimitMiddleware(rate_limit=0.5))
dp.callback_query.middleware(RateLimitMiddleware(rate_limit=0.3))
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

```python
# config.py (—É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ Priority 1)
CALLBACK_MESSAGE_TTL_HOURS = 48  # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TTL

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- **24 —á–∞—Å–∞** - –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –±–æ—Ç–æ–≤ (–µ–¥–∞, –¥–æ—Å—Ç–∞–≤–∫–∞)
- **48 —á–∞—Å–æ–≤** - –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ (–∑–∞–ø–∏—Å—å, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
- **72 —á–∞—Å–∞** - –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö (–∑–∞–∫–∞–∑—ã, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏)

### Rate Limiting

```python
RateLimitedCleanupMiddleware(
    ttl_hours=48,
    max_attempts=5  # –ú–∞–∫—Å –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ –º–∏–Ω—É—Ç—É
)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- **3-5** - –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –±–æ—Ç–æ–≤
- **10** - –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö/–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | Basic | RateLimited | Smart |
|---|:---:|:---:|:---:|
| –ü—Ä–æ—Å—Ç–æ—Ç–∞ | ‚úÖ‚úÖ‚úÖ | ‚úÖ‚úÖ | ‚úÖ |
| –ü–∞–º—è—Ç—å | ‚úÖ‚úÖ‚úÖ | ‚úÖ‚úÖ | ‚úÖ‚úÖ |
| –ì–∏–±–∫–æ—Å—Ç—å | ‚úÖ | ‚úÖ | ‚úÖ‚úÖ‚úÖ |
| –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ | ‚ùå | ‚úÖ‚úÖ‚úÖ | ‚ùå |
| UX | ‚úÖ‚úÖ | ‚úÖ‚úÖ | ‚úÖ‚úÖ‚úÖ |
| –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è | ‚úÖ‚úÖ‚úÖ | ‚úÖ‚úÖ | ‚úÖ |

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä main.py

```python
import asyncio
import logging

from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.memory import MemoryStorage

from config import BOT_TOKEN
from middlewares.message_cleanup import MessageCleanupMiddleware
from middlewares.rate_limit import RateLimitMiddleware
from database.queries import Database

# ... –∏–º–ø–æ—Ä—Ç—ã handlers

async def start_bot():
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    bot = Bot(token=BOT_TOKEN)
    storage = MemoryStorage()
    dp = Dispatcher(storage=storage)
    
    # –ë–î
    await Database.init_db()
    
    # ‚úÖ P3: MIDDLEWARE –î–õ–Ø –û–ß–ò–°–¢–ö–ò –°–¢–ê–†–´–• –°–û–û–ë–©–ï–ù–ò–ô
    dp.callback_query.middleware(MessageCleanupMiddleware(ttl_hours=48))
    
    # Rate limiting
    dp.message.middleware(RateLimitMiddleware(rate_limit=0.5))
    dp.callback_query.middleware(RateLimitMiddleware(rate_limit=0.3))
    
    # –†–æ—É—Ç–µ—Ä—ã
    dp.include_router(booking_handlers.router)
    dp.include_router(user_handlers.router)
    dp.include_router(admin_handlers.router)
    
    # –ó–∞–ø—É—Å–∫
    logging.info("üöÄ Bot started with MessageCleanupMiddleware (TTL=48h)")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(start_bot())
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ

- [ ] –°–≤–µ–∂–∏–µ –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- [ ] –°—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (>TTL) –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
- [ ] –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "–£—Å—Ç–∞—Ä–µ–ª–æ"
- [ ] –ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
- [ ] –°–æ—Å—Ç–æ—è–Ω–∏–µ FSM –æ—á–∏—â–∞–µ—Ç—Å—è

### Rate Limiting (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

- [ ] 5 –Ω–∞–∂–∞—Ç–∏–π –∑–∞ –º–∏–Ω—É—Ç—É –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] 6-–µ –Ω–∞–∂–∞—Ç–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- [ ] –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ"
- [ ] –ß–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É —Å–Ω–æ–≤–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

### Smart TTL (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

- [ ] –ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç –∑–∞ 12—á
- [ ] –°–ª–æ—Ç—ã —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç –∑–∞ 6—á
- [ ] –°–ø–∏—Å–∫–∏ —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç –∑–∞ 24—á
- [ ] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç –∑–∞ 48—á

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
- [ ] –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è user_id
- [ ] –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤–æ–∑—Ä–∞—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- [ ] –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è callback_data

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ü—Ä–æ–±–ª–µ–º—ã —Å Telegram API**
   - –ò–Ω–æ–≥–¥–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫–∏ (—Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
   - –†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É

2. **–ü–∞–º—è—Ç—å –≤ RateLimited**
   - –•—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ RAM
   - –û—á–∏—â–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
   - –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è

3. **Timezone**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç TIMEZONE –∏–∑ config
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –æ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## üîß –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–∏—Ç—å DEBUG –ª–æ–≥–∏

```python
logging.basicConfig(
    level=logging.DEBUG,  # –í–º–µ—Å—Ç–æ INFO
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ TTL+1 —á–∞—Å
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```
INFO - Blocked interaction with old message: user=123456, age=49h, callback=time:...
```

---

## ‚ùì FAQ

**Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ middleware?**
A: –ù–µ—Ç, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç.

**Q: –ü–æ—á–µ–º—É –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏?**
A: Telegram –º–æ–∂–µ—Ç –Ω–µ –ø–æ–∑–≤–æ–ª—è—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—á–µ–Ω—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

**Q: –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å TTL?**
A: –ò–∑–º–µ–Ω–∏—Ç–µ `CALLBACK_MESSAGE_TTL_HOURS` –≤ `config.py` –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ `ttl_hours` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏.

**Q: –†–∞–±–æ—Ç–∞–µ—Ç —Å Priority 1?**
A: –î–∞! –û–Ω–∏ –¥–æ–ø–æ–ª–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞. Priority 1 - –≤–∞–ª–∏–¥–∞—Ü–∏—è, Priority 3 - –∞–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞.

---

## üéì –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Aiogram Middlewares](https://docs.aiogram.dev/en/latest/dispatcher/middlewares.html)
- [Priority 1: Callback Validation](../utils/callback_validator.py)
- [Config Settings](../config.py)
